<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monthly Competition â€” Rugrats vs Filekeepers</title>
<style>
  :root{--bg:#DDECD5;--text:#1a1a1a;--green:#1eff78;--orange:#ff9626;}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif;}
  header{text-align:center;padding:1rem 0 .5rem;}
  h1{margin:0;font-size:2.4rem;font-weight:800;}
  .bar-wrapper{width:80%;height:40px;margin:1.5rem auto;border-radius:40px;
    background:linear-gradient(90deg,var(--green),var(--orange));position:relative;overflow:hidden;}
  .beam{position:absolute;width:100%;height:100%;
    background:radial-gradient(circle,rgba(255,255,150,.35),transparent 70%);
    animation:beam 6s linear infinite;}
  @keyframes beam{0%{transform:translateX(-60%);}50%{transform:translateX(600%);}100%{transform:translateX(-60%);}}
  .bar-labels{width:80%;margin:.4rem auto 1.5rem;display:flex;justify-content:space-between;font-weight:700;}
  .dashboard{width:90%;margin:auto;display:flex;gap:19rem;position:relative;}
  .team{flex:1;background:#fff;border-radius:46px;box-shadow:0 10px 25px rgba(0,0,0,.08);min-width:580px;}
  table{width:100%;border-collapse:collapse;}
  td,th{padding:8px;border-bottom:1px solid #eee;text-align:center;}
  th{text-transform:uppercase;font-weight:700;background:#7ccf81;color:#fff;}
  .orange th{background:#f59f3a;}
  tr:nth-child(even) td{background:#f9f9f9;}
  h2{text-align:center;margin:0;padding:.8rem;font-weight:800;background:#f0fdf5;color:var(--green);}
  h2.orange{background:#fff5e9;color:var(--orange);}
  .sum-row{background:#333;color:#fff;font-weight:700;}
  .totals-center{position:absolute;top:30%;left:50%;transform:translate(-50%,-50%);
    background:#fff;border-radius:65px;padding:1.3rem 2.3rem;font-weight:800;text-align:center;
    box-shadow:0 10px 25px rgba(0,0,0,.15);}
  footer{text-align:center;margin:1rem;color:#777;font-size:.9rem;}
</style>
</head>
<body>

<header>
  <h1>Monthly Competition</h1>
  <div class="bar-wrapper"><div class="beam"></div></div>
  <div class="bar-labels">
    <span id="rugrats-label">ðŸŸ¢ Rugrats: 0% (0)</span>
    <span id="filekeepers-label">ðŸŸ  Filekeepers: 0% (0)</span>
  </div>
</header>

<div class="dashboard">
  <div class="team">
    <h2>ðŸŸ¢ Rugrats</h2>
    <table id="table-rugrats">
      <thead><tr><th>Agent</th><th>ID</th><th>CR Pull</th><th>Xfer</th><th>Total</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr class="sum-row"><td colspan="2">TOTAL</td><td id="rug-cr">0</td><td id="rug-xf">0</td><td id="rug-total">0</td></tr></tfoot>
    </table>
  </div>

  <div class="totals-center">
    <div style="font-size:1.1rem;margin-bottom:.3rem;">Xfer Totals</div>
    <span id="rug-xfer-total">0</span>
    <span style="font-size:1.2rem;">ðŸŸ¢ vs ðŸŸ </span>
    <span id="fk-xfer-total">0</span>
  </div>

  <div class="team orange">
    <h2 class="orange">ðŸŸ  Filekeepers</h2>
    <table id="table-filekeepers">
      <thead><tr><th>Agent</th><th>ID</th><th>CR Pull</th><th>Xfer</th><th>Total</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr class="sum-row"><td colspan="2">TOTAL</td><td id="fk-cr">0</td><td id="fk-xf">0</td><td id="fk-total">0</td></tr></tfoot>
    </table>
  </div>
</div>

<footer>Endless Marketing Services â€” Monthly Dashboard</footer>

<script>
const SHEET_ID ="1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const API_KEY  ="AIzaSyB0TtVnOafgkbRwCaqkSxPogGLUgyWqZaE";

// ---------------- LEER LA SEMANA MÃS RECIENTE ----------------
async function getLatestWeekSheet(){
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`);
    const json = await res.json();
    const weeks = json.sheets
        .map(s=>s.properties.title)
        .filter(n=>/^W\d{2}$/.test(n))
        .sort((a,b)=>Number(b.slice(1))-Number(a.slice(1)));
    return weeks[0]; // â† Ãºltima semana creada (la vigente)
}

// ------------------ CARGAR TABLAS ------------------
async function loadData(){
    const sheet = await getLatestWeekSheet();
    const range = `${sheet}!A:T`;

    const [teamReq,dataReq]=await Promise.all([
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Teams!A3:O100?key=${API_KEY}`),
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`)
    ]);

    const teams=(await teamReq.json()).values||[];
    const rows =(await dataReq.json()).values||[];

    let map=new Map();
    let hasValues = false; // detecta si ya existe data real

rows.slice(2).forEach(r=>{
    if(!r[0]) return;

    // SUMA DE TODAS LAS COLUMNAS DE XFERS
    const xf = 
      (+r[6]||0) +   // XFER Wed
      (+r[8]||0) +   // XFER Thu
      (+r[10]||0) +  // XFER Fri
      (+r[12]||0) +  // XFER Sat
      (+r[14]||0) +  // XFER Mon
      (+r[16]||0);   // XFER Tue

    // SUMA DE TODAS LAS COLUMNAS DE CRPULL
    const cr = 
      (+r[5]||0) +
      (+r[7]||0) +
      (+r[9]||0) +
      (+r[11]||0) +
      (+r[13]||0) +
      (+r[15]||0);

    map.set(r[0], {cr, xf, total: cr + xf});
});

    let RR=[],FK=[];
    teams.forEach(r=>{
       if(r[1]) FK.push({name:r[0],id:r[1],...(map.get(r[1])||{cr:0,xf:0,total:0})});
       if(r[14]) RR.push({name:r[13],id:r[14],...(map.get(r[14])||{cr:0,xf:0,total:0})});
    });

    // Si existen valores reales â†’ ordenar por resultados
    if(hasValues){
       RR.sort((a,b)=>b.total-a.total);
       FK.sort((a,b)=>b.total-a.total);
    }

    render("rug",RR);
    render("fk",FK);
    updateHeader();
    console.log(`ðŸ“Œ Mostrando datos de: ${sheet}`);
}

// ------------------ RENDER TABLAS ------------------
function render(side,arr){
    const container = `#table-${side=="rug"?"rugrats":"filekeepers"} tbody`;
    const body=document.querySelector(container);
    body.innerHTML="";

    let cr=0,xf=0,total=0;
    arr.forEach(d=>{
       cr+=d.cr; xf+=d.xf; total+=d.total;
       body.innerHTML+=`<tr><td>${d.name}</td><td>${d.id}</td><td>${d.cr}</td><td>${d.xf}</td><td>${d.total}</td></tr>`;
    });

    document.getElementById(`${side}-cr`).textContent=cr;
    document.getElementById(`${side}-xf`).textContent=xf;
    document.getElementById(`${side}-total`).textContent=total;

    if(side=="rug") window.rr=xf; else window.fk=xf;
}

// ------------------ PORCENTAJES SOLO XFER ------------------
function updateHeader(){
   const r=window.rr||0, f=window.fk||0;
   const pct=v=>((v/(r+f||1))*100).toFixed(1)+"%";

   document.getElementById("rugrats-label").textContent    =`ðŸŸ¢ Rugrats: ${pct(r)} (${r})`;
   document.getElementById("filekeepers-label").textContent=`ðŸŸ  Filekeepers: ${pct(f)} (${f})`;

   document.getElementById("rug-xfer-total").textContent=r;
   document.getElementById("fk-xfer-total").textContent=f;
}

// ---------------- REFRESH CADA 60s ----------------
loadData();
setInterval(loadData,60000);
</script>
</body>
</html>

