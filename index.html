\<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monthly Competition ‚Äî Rugrats vs Filekeepers</title>
<style>
  :root {
    --bg: #DDECD5;
    --text: #1a1a1a;
    --green: #1eff78;
    --orange: #ff9626;
  }

  body {
    margin: 0;
    font-family: "Inter", system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
  }

  header {
    text-align: center;
    padding: 1rem 0 0.5rem 0;
  }

  h1 {
    font-size: 2.4rem;
    font-weight: 800;
    margin-bottom: 0.3rem;
  }

  #week-num { display: none; }

  /* ===== Cinematic Beam Bar ===== */
  .bar-wrapper {
    position: relative;
    width: 80%;
    height: 40px;
    margin: 1.5rem auto;
    background: linear-gradient(90deg, var(--green), var(--orange));
    border-radius: 40px;
    overflow: hidden;
    box-shadow: 0 0 25px rgba(0,0,0,0.25) inset;
  }

  .beam {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,150,0.4) 0%, transparent 70%);
    animation: beamMove 6s linear infinite;
  }

  @keyframes beamMove {
    0% { transform: translateX(-60%); opacity: 0.4; }
    50% { transform: translateX(600%); opacity: 1; }
    100% { transform: translateX(-60%); opacity: 0.4; }
  }

  .bar-labels {
    display: flex;
    justify-content: space-between;
    width: 80%;
    margin: 0.5rem auto 1.5rem auto;
    font-weight: 700;
    font-size: 1rem;
  }

  /* ===== Dashboard ===== */
  .dashboard {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: 90%;
    margin: 1rem auto 3rem auto;
    gap: 19rem;
    position: relative;
  }

  .team {
    flex: 1;
    background: #fff;
    border-radius: 46px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    overflow: hidden;
    min-width: 580px;
    max-width: 840px;
  }

  h2 {
    text-align: center;
    color: var(--green);
    background: #f0fdf5;
    padding: 0.8rem;
    font-size: 1.4rem;
    font-weight: 800;
    margin: 0;
  }

  h2.orange {
    color: var(--orange);
    background: #fff5e9;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    font-size: 1.0rem;
  }

  th, td {
    padding: 8px 10px;
    border-bottom: 1px solid #eee;
  }

  th {
    background: #7ccf81;
    color: white;
    font-weight: 700;
    text-transform: uppercase;
  }

  .team.orange th { background: #f59f3a; }

  tr:nth-child(even) td { background: #f9f9f9; }

  .sum-row {
    background: #333;
    color: white;
    font-weight: 700;
  }

  /* === Middle XFER Totals === */
  .totals-center {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -55%);
    background: rgba(255,255,255,0.95);
    border-radius: 65px;
    padding: 1.3rem 2.3rem;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    backdrop-filter: blur(6px);
    border: 2px solid rgba(0,0,0,0.05);
  }

  .totals-center h3 {
    margin: 0;
    font-size: 1.3rem;
    color: #333;
  }

  .totals-center span {
    display: block;
    font-size: 2.7rem;
    font-weight: 800;
    margin: 0.3rem 0;
    transition: all 0.3s ease-in-out;
  }

  .win { color: #1da850; }
  .lose { color: #c45100; opacity: 0.8; }

  footer {
    text-align: center;
    font-size: 0.9rem;
    color: #777;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>
<header>
  <h1>Monthly Competition</h1>
  <div class="bar-wrapper"><div class="beam"></div></div>
  <div class="bar-labels">
    <span id="rugrats-label">ü¶ñ Rugrats: 0% (0)</span>
    <span id="filekeepers-label">‚ò†Ô∏è Money Makers: 0% (0)</span>
  </div>
</header>

<div class="dashboard">
  <div class="team">
    <h2>ü¶ñ Rugrats</h2>
    <table id="table-rugrats">
      <thead>
        <tr><th>Agent</th><th>ID</th><th>Cr Pull</th><th>Xfer</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr class="sum-row"><td colspan="2">TOTAL</td><td id="rug-cr">0</td><td id="rug-xf">0</td><td id="rug-total">0</td></tr></tfoot>
    </table>
  </div>

  <!-- Middle Totals Box -->
  <div class="totals-center" id="totals-center">
    <h3>XFER Totals</h3>
    <span id="rug-xfer-total">0</span>
    <span style="font-size:3.0rem;">ü¶ñ vs ‚ò†üßëüèø‚Äçüåæ</span>
    <span id="fk-xfer-total">0</span>
  </div>

  <div class="team orange">
    <h2 class="orange">üßëüèø‚Äçüåæ Cotton Pickers</h2>
    <table id="table-filekeepers">
      <thead>
        <tr><th>Agent</th><th>ID</th><th>Cr Pull</th><th>Xfer</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr class="sum-row"><td colspan="2">TOTAL</td><td id="fk-cr">0</td><td id="fk-xf">0</td><td id="fk-total">0</td></tr></tfoot>
    </table>
  </div>
</div>

<footer>Endless Marketing Services ‚Äî Monthly Dashboard</footer>

<script>
const SHEET_ID = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const API_KEY  = "AIzaSyB0TtVnOafgkbRwCaqkSxPogGLUgyWqZaE";

const TIMEZONE = "America/Tijuana";

/* ===================== Helpers ===================== */
function num(v) {
  const n = Number(String(v ?? "").replace(/,/g, "").trim());
  return Number.isFinite(n) ? n : 0; // evita NaN
}
function pad2(n) { return String(n).padStart(2, "0"); }

function nowTZ() {
  // fecha ‚Äúlocal‚Äù a tu TZ sin dependencias
  const s = new Date().toLocaleString("en-US", { timeZone: TIMEZONE });
  return new Date(s);
}

// semana ‚Äúsimple‚Äù (tu l√≥gica original-ish)
function getCurrentWeekNumber() {
  const now = nowTZ();
  const firstJan = new Date(now.getFullYear(), 0, 1);
  const days = Math.floor((now - firstJan) / 86400000);
  let weekNum = Math.ceil((days + firstJan.getDay() + 1) / 7);
  if (weekNum < 1) weekNum = 1;
  if (weekNum > 53) weekNum = 53;
  return weekNum; // number
}

async function fetchJSON(url, { tries = 4, baseDelay = 700 } = {}) {
  let lastErr;
  for (let i = 0; i < tries; i++) {
    try {
      const r = await fetch(url, { cache: "no-store" });
      const text = await r.text();
      if (r.ok) return JSON.parse(text);

      // rate limit / server issues
      if (r.status === 429 || (r.status >= 500 && r.status < 600)) {
        const jitter = Math.random() * 250;
        await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, i) + jitter));
        continue;
      }

      throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`);
    } catch (e) {
      lastErr = e;
      const jitter = Math.random() * 250;
      await new Promise(res => setTimeout(res, baseDelay * Math.pow(2, i) + jitter));
    }
  }
  throw lastErr || new Error("fetchJSON: unknown");
}

async function listSheetTitles() {
  // cache 10 min para no pegarle duro al API
  const cache = window.__tabsCache;
  if (cache && (Date.now() - cache.at) < 10 * 60 * 1000) return cache.titles;

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?fields=sheets(properties(title))&key=${API_KEY}`;
  const j = await fetchJSON(url);
  const titles = (j.sheets || []).map(s => s?.properties?.title).filter(Boolean);

  window.__tabsCache = { at: Date.now(), titles };
  return titles;
}

function extractW(t) {
  const m = String(t).trim().match(/^W(\d{1,2})$/i);
  if (!m) return null;
  const n = Number(m[1]);
  if (!Number.isFinite(n)) return null;
  return { title: `W${pad2(n)}`, n };
}

async function sheetValues(rangeA1) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(rangeA1)}?valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
  const j = await fetchJSON(url);
  return j.values || [];
}

/* ===================== Month detection ===================== */
/*
  Para sumar ‚Äúsolo mes actual‚Äù necesitamos saber a qu√© mes pertenece cada W.
  Esto intenta leer una fecha del header del tab.

  üü° IMPORTANTE:
  Funciona si en tu Wxx hay al menos 1 celda con fecha en la fila 1 (o las primeras filas).
  Ejemplos v√°lidos:
    - fecha real (UNFORMATTED_VALUE) tipo 45567 (serial) NO siempre viene; depende del sheet
    - texto "1/5/2026", "01/05/2026", "Jan 05", "Jan 05 2026", etc.
*/
function tryParseDate(value) {
  if (value == null) return null;

  // si viene como texto
  const s = String(value).trim();
  if (!s) return null;

  // intenta Date nativo (sirve para "1/5/2026", "Jan 05 2026", etc.)
  const d1 = new Date(s);
  if (Number.isFinite(d1.getTime())) return d1;

  // si viene como n√∫mero y fuera serial date‚Ä¶ (Google Sheets serial)
  // OJO: Esto depende; a veces viene como string num√©rico tambi√©n
  const n = Number(s);
  if (Number.isFinite(n) && n > 20000 && n < 90000) {
    // Google Sheets serial date base: 1899-12-30
    const base = new Date(Date.UTC(1899, 11, 30));
    const ms = base.getTime() + n * 86400000;
    const d2 = new Date(ms);
    if (Number.isFinite(d2.getTime())) return d2;
  }

  return null;
}

async function getWeekTabMonthKey(tabTitle) {
  // cache por tab para no re-leer siempre
  window.__wkMonth = window.__wkMonth || new Map();
  if (window.__wkMonth.has(tabTitle)) return window.__wkMonth.get(tabTitle);

  // lee un pedacito ‚Äúbarato‚Äù del header
  // si tus fechas est√°n en otra zona, ajusta aqu√≠ (B1:T2, etc.)
  const header = await sheetValues(`${tabTitle}!A1:T2`);

  let found = null;
  for (const row of header) {
    for (const cell of row) {
      const d = tryParseDate(cell);
      if (d) { found = d; break; }
    }
    if (found) break;
  }

  // si no encontramos fecha, devolvemos null (y luego hacemos fallback)
  const key = found ? `${found.getFullYear()}-${pad2(found.getMonth() + 1)}` : null;
  window.__wkMonth.set(tabTitle, key);
  return key;
}

/* ===================== Pick tabs to use ===================== */
async function getActiveWeeklyTabsForCurrentMonth() {
  const titles = await listSheetTitles();
  const weekTabs = titles.map(extractW).filter(Boolean);

  if (!weekTabs.length) {
    throw new Error('No encontr√© tabs tipo "W01/W02/..." en este spreadsheet.');
  }

  // 1) ‚ÄúA√±o nuevo‚Äù: usar semana actual para no caer en W52 cuando ya vas en W01
  const currentWeek = getCurrentWeekNumber();
  const candidates = weekTabs
    .filter(w => w.n >= 1 && w.n <= currentWeek)
    .map(w => w.title);

  // si no hay ninguna (raro), fallback: usa la menor existente
  const baseCandidates = candidates.length ? candidates : weekTabs.map(w => w.title);

  // 2) ‚ÄúMonthly‚Äù: filtra por mes actual usando fechas del header
  const now = nowTZ();
  const monthKeyNow = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}`;

  const monthTabs = [];
  for (const t of baseCandidates.sort()) {
    const mk = await getWeekTabMonthKey(t);
    if (mk && mk === monthKeyNow) monthTabs.push(t);
  }

  // Si no pudimos detectar mes (porque no hay fechas en headers),
  // fallback: solo usa la √∫ltima semana existente <= currentWeek
  if (!monthTabs.length) {
    const best = baseCandidates
      .map(extractW).filter(Boolean)
      .sort((a,b)=>b.n-a.n)[0];

    console.warn("‚ö†Ô∏è No pude detectar mes por fechas en headers. Fallback a una sola semana:", best?.title);
    return { tabs: [best?.title || baseCandidates[0]], mode: "fallback-single-week", monthKeyNow };
  }

  return { tabs: monthTabs, mode: "month-sum", monthKeyNow };
}

/* ===================== Core load ===================== */
async function loadData() {
  try {
    const teamRange = `Teams!A3:O100`;
    const teamData  = (await fetchJSON(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(teamRange)}?key=${API_KEY}`
    )).values || [];

    // Tabs a sumar (solo mes actual)
    const { tabs, mode, monthKeyNow } = await getActiveWeeklyTabsForCurrentMonth();
    console.log("üß† Using weekly tabs:", tabs, "mode:", mode, "month:", monthKeyNow);

    // 1) Vamos a sumar CRPULL/XFER de TODAS las tabs del mes
    const map = new Map(); // id -> {cr, xf, total}

    for (const weeklyTab of tabs) {
      const dataRange = `${weeklyTab}!A1:T100`;
      const dataValues = (await fetchJSON(
        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(dataRange)}?valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`
      )).values || [];

      if (dataValues.length < 3) continue;

      const subHeaders = dataValues[1] || [];
      const crIndexes = [];
      const xfIndexes = [];

      subHeaders.forEach((h, i) => {
        const H = String(h || "").trim().toUpperCase();
        if (H === "CRPULL") crIndexes.push(i);
        if (H === "XFER")   xfIndexes.push(i);
      });

      if (!crIndexes.length || !xfIndexes.length) {
        console.warn(`‚ö†Ô∏è ${weeklyTab}: no encontr√© CRPULL/XFER, la salto.`);
        continue;
      }

      dataValues.slice(2).forEach(row => {
        const id = String(row[0] || "").trim();
        if (!id) return;

        let cr = 0, xf = 0;
        crIndexes.forEach(i => cr += num(row[i]));
        xfIndexes.forEach(i => xf += num(row[i]));

        const prev = map.get(id) || { cr:0, xf:0, total:0 };
        const next = {
          cr: prev.cr + cr,
          xf: prev.xf + xf,
          total: (prev.cr + cr) + (prev.xf + xf)
        };
        map.set(id, next);
      });
    }

    // 2) Render teams
    const fkBody = document.querySelector("#table-filekeepers tbody");
    const rrBody = document.querySelector("#table-rugrats tbody");
    fkBody.innerHTML = rrBody.innerHTML = "";

    const fkArr = [];
    const rrArr = [];

    teamData.forEach(row => {
      const fkName = String(row[0]  || "").trim();
      const fkId   = String(row[1]  || "").trim();
      const rrName = String(row[13] || "").trim();
      const rrId   = String(row[14] || "").trim();

      if (fkId) fkArr.push({ name: fkName, id: fkId, ...(map.get(fkId) || { cr:0, xf:0, total:0 }) });
      if (rrId) rrArr.push({ name: rrName, id: rrId, ...(map.get(rrId) || { cr:0, xf:0, total:0 }) });
    });

    fkArr.sort((a,b)=> b.total - a.total);
    rrArr.sort((a,b)=> b.total - a.total);

    let fkCr=0,fkXf=0,fkTot=0, rrCr=0,rrXf=0,rrTot=0;

    fkArr.forEach(d=>{
      fkCr += num(d.cr); fkXf += num(d.xf); fkTot += num(d.total);
      fkBody.insertAdjacentHTML("beforeend",
        `<tr><td>${d.name}</td><td>${d.id}</td><td>${num(d.cr)}</td><td>${num(d.xf)}</td><td>${num(d.total)}</td></tr>`
      );
    });

    rrArr.forEach(d=>{
      rrCr += num(d.cr); rrXf += num(d.xf); rrTot += num(d.total);
      rrBody.insertAdjacentHTML("beforeend",
        `<tr><td>${d.name}</td><td>${d.id}</td><td>${num(d.cr)}</td><td>${num(d.xf)}</td><td>${num(d.total)}</td></tr>`
      );
    });

    // 3) Totales UI
    document.getElementById("fk-cr").textContent    = fkCr;
    document.getElementById("fk-xf").textContent    = fkXf;
    document.getElementById("fk-total").textContent = fkTot;

    document.getElementById("rug-cr").textContent    = rrCr;
    document.getElementById("rug-xf").textContent    = rrXf;
    document.getElementById("rug-total").textContent = rrTot;

    const total = (fkTot + rrTot) > 0 ? (fkTot + rrTot) : 1;
    const rugPct = (rrTot / total) * 100;
    const fkPct  = (fkTot / total) * 100;

    document.getElementById("rugrats-label").textContent     = ` ü¶ñ Rugrats: ${rugPct.toFixed(1)}% (${rrTot})`;
    document.getElementById("filekeepers-label").textContent = `üßëüèø‚Äçüåæ Filekeepers: ${fkPct.toFixed(1)}% (${fkTot})`;

    const rugXferBox = document.getElementById("rug-xfer-total");
    const fkXferBox  = document.getElementById("fk-xfer-total");
    rugXferBox.textContent = rrXf;
    fkXferBox.textContent  = fkXf;

    rugXferBox.classList.remove("win","lose");
    fkXferBox.classList.remove("win","lose");
    if (rrXf > fkXf){ rugXferBox.classList.add("win"); fkXferBox.classList.add("lose"); }
    else if (fkXf > rrXf){ fkXferBox.classList.add("win"); rugXferBox.classList.add("lose"); }

    console.log("‚úÖ Monthly sum OK", { tabsUsed: tabs, fkTot, rrTot, fkXf, rrXf });

  } catch (err) {
    console.error("‚ùå Error al cargar los datos:", err);
  }
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
