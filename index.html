<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monthly Competition ‚Äî Rugrats vs Filekeepers</title>
<style>
  :root {
    --bg: #DDECD5;
    --text: #1a1a1a;
    --green: #1eff78;
    --orange: #ff9626;
  }

  body {
    margin: 0;
    font-family: "Inter", system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
  }

  header { text-align: center; padding: 1rem 0 0.3rem; }
  h1 { font-size: 2.4rem; font-weight: 800; margin-bottom: 0.1rem; }

  /* Semana discreta */
  #week-display {
    font-size: 0.9rem;
    margin-top: -4px;
    color: #555;
    opacity: .7;
  }

  .bar-wrapper {
    width: 80%; height: 40px; margin: 1rem auto;
    background: linear-gradient(90deg, var(--green), var(--orange));
    border-radius: 40px; overflow: hidden; position: relative;
  }
  .beam {
    position: absolute; inset: 0;
    background: radial-gradient(circle, rgba(255,255,150,.4) 0%, transparent 70%);
    animation: move 6s linear infinite;
  }
  @keyframes move {
    0% { transform: translateX(-60%); opacity:.4 }
    50%{ transform: translateX(600%); opacity:1 }
    100%{ transform: translateX(-60%); opacity:.4 }
  }

  .bar-labels {
    display: flex; justify-content: space-between;
    width: 80%; margin: .5rem auto 1.5rem;
    font-weight: 700; font-size: 1rem;
  }

  .dashboard {
    display: flex; justify-content: center;
    gap: 19rem; width: 90%; margin: auto;
    position: relative;
  }

  .team {
    background: #fff; border-radius: 46px;
    min-width: 580px; max-width: 840px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    overflow: hidden;
  }

  h2 { text-align: center; padding: .8rem; margin: 0;
       font-size: 1.4rem; font-weight: 800; }
  h2.orange { color: var(--orange); background: #fff5e9; }
  h2 { color: var(--green); background: #f0fdf5; }

  table { width: 100%; border-collapse: collapse; text-align: center; }
  th, td { padding: 8px 10px; }
  th { background: #7ccf81; color: #fff; font-weight: 700; }
  .team.orange th { background: #f59f3a; }
  tr:nth-child(even) td { background: #f9f9f9; }

  .sum-row { background: #333; color: #fff; font-weight: 700; }

  .totals-center {
    position: absolute;
    top: 30%; left: 50%; transform: translate(-50%,-50%);
    background: rgba(255,255,255,.95);
    padding: 1.3rem 2.3rem;
    border-radius: 65px;
    text-align: center;
    font-weight: 800;
    box-shadow: 0 8px 25px rgba(0,0,0,.15);
  }

  .win { color: #1da850; }
  .lose { color: #c45100; opacity:.8; }

  footer {
    text-align: center; margin-top: 1rem;
    font-size: .9rem; color: #777;
  }
</style>
</head>
<body>

<header>
  <h1>Monthly Competition</h1>
  <div id="week-display">Week: ‚Äî</div>

  <div class="bar-wrapper"><div class="beam"></div></div>
  <div class="bar-labels">
    <span id="rugrats-label">üü¢ Rugrats: 0% (0)</span>
    <span id="filekeepers-label">üü† Filekeepers: 0% (0)</span>
  </div>
</header>


<div class="dashboard">

  <div class="team">
    <h2>üü¢ Rugrats</h2>
    <table id="table-rugrats">
      <thead>
        <tr><th>Agent</th><th>ID</th><th>Cr Pull</th><th>Xfer</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr class="sum-row">
        <td colspan="2">TOTAL</td><td id="rug-cr">0</td><td id="rug-xf">0</td><td id="rug-total">0</td>
      </tr></tfoot>
    </table>
  </div>

  <div class="totals-center">
    <h3>XFER Totals</h3>
    <span id="rug-xfer-total">0</span>
    <span style="font-size:1.3rem;">üü¢ vs üü†</span>
    <span id="fk-xfer-total">0</span>
  </div>

  <div class="team orange">
    <h2 class="orange">üü† Filekeepers</h2>
    <table id="table-filekeepers">
      <thead>
        <tr><th>Agent</th><th>ID</th><th>Cr Pull</th><th>Xfer</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr class="sum-row">
        <td colspan="2">TOTAL</td><td id="fk-cr">0</td><td id="fk-xf">0</td><td id="fk-total">0</td>
      </tr></tfoot>
    </table>
  </div>

</div>

<footer>Endless Marketing Services ‚Äî Monthly Dashboard</footer>

<script>
const SHEET_ID = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const API_KEY = "AIzaSyB0TtVnOafgkbRwCaqkSxPogGLUgyWqZaE";

/* ===========================================================
   SEMANA CORREGIDA (UTC) + FIX ESPECIAL PARA EL A√ëO 2025
   =========================================================== */
function getCurrentWeekNumber() {

  const now = new Date();

  // Fecha en UTC para evitar desmadres de timezone
  const utc = new Date(Date.UTC(
    now.getFullYear(),
    now.getMonth(),
    now.getDate()
  ));

  const start = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));

  let week = Math.ceil(((utc - start) / 86400000 + 1) / 7);

  /* 
     üî• FIX DEFINITIVO:
     Tus pesta√±as est√°n 1 semana ADELANTADAS vs ISO-8601
     ‚Üí Todo el 2025 debe llevar +1 semana para coincidir
  */
  if (utc.getUTCFullYear() === 2025) {
    week = week + 1;
  }

  return `W${week.toString().padStart(2, "0")}`;
}

async function loadData() {

  const week = getCurrentWeekNumber();
  document.getElementById("week-display").textContent = `Week: ${week}`;

  const dataRange = `${week}!A1:T300`;
  const teamRange = "Teams!A3:O150";

  try {

    const [teamRes, dataRes] = await Promise.all([
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${teamRange}?key=${API_KEY}`),
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${dataRange}?key=${API_KEY}`)
    ]);

    const teamData = (await teamRes.json()).values || [];
    const dataValues = (await dataRes.json()).values || [];

    const map = new Map();
    dataValues.slice(2).forEach(row => {
      const id = row[0]?.trim();
      if (!id) return;
      const cr = Number(row[18] || 0);
      const xf = Number(row[19] || 0);
      map.set(id, { cr, xf, total: cr + xf });
    });

    const fkBody = document.querySelector("#table-filekeepers tbody");
    const rrBody = document.querySelector("#table-rugrats tbody");
    fkBody.innerHTML = rrBody.innerHTML = "";

    const fkArr = [];
    const rrArr = [];

    teamData.forEach(row => {
      const fkName = row[0]?.trim();
      const fkId = row[1]?.trim();
      const rrName = row[13]?.trim();
      const rrId = row[14]?.trim();

      if (fkId) fkArr.push({ name: fkName, id: fkId, ...(map.get(fkId) ?? {cr:0,xf:0,total:0}) });
      if (rrId) rrArr.push({ name: rrName, id: rrId, ...(map.get(rrId) ?? {cr:0,xf:0,total:0}) });
    });

    fkArr.sort((a,b)=>b.total-a.total);
    rrArr.sort((a,b)=>b.total-a.total);

    let fkCr=0, fkXf=0, fkTot=0, rrCr=0, rrXf=0, rrTot=0;

    fkArr.forEach(d=>{
      fkCr+=d.cr; fkXf+=d.xf; fkTot+=d.total;
      fkBody.insertAdjacentHTML("beforeend",
        `<tr><td>${d.name}</td><td>${d.id}</td><td>${d.cr}</td><td>${d.xf}</td><td>${d.total}</td></tr>`
      );
    });

    rrArr.forEach(d=>{
      rrCr+=d.cr; rrXf+=d.xf; rrTot+=d.total;
      rrBody.insertAdjacentHTML("beforeend",
        `<tr><td>${d.name}</td><td>${d.id}</td><td>${d.cr}</td><td>${d.xf}</td><td>${d.total}</td></tr>`
      );
    });

    document.getElementById("fk-cr").textContent = fkCr;
    document.getElementById("fk-xf").textContent = fkXf;
    document.getElementById("fk-total").textContent = fkTot;

    document.getElementById("rug-cr").textContent = rrCr;
    document.getElementById("rug-xf").textContent = rrXf;
    document.getElementById("rug-total").textContent = rrTot;

    const total = fkTot + rrTot;
    document.getElementById("rugrats-label").textContent =
      `üü¢ Rugrats: ${(rrTot/total*100).toFixed(1)}% (${rrTot})`;
    document.getElementById("filekeepers-label").textContent =
      `üü† Filekeepers: ${(fkTot/total*100).toFixed(1)}% (${fkTot})`;

    const rugBox = document.getElementById("rug-xfer-total");
    const fkBox = document.getElementById("fk-xfer-total");

    rugBox.textContent = rrXf;
    fkBox.textContent = fkXf;

    rugBox.classList.remove("win","lose");
    fkBox.classList.remove("win","lose");

    if (rrXf > fkXf) {
      rugBox.classList.add("win");
      fkBox.classList.add("lose");
    } else {
      fkBox.classList.add("win");
      rugBox.classList.add("lose");
    }

  } catch (err) {
    console.error("‚ùå ERROR:", err);
  }
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>

